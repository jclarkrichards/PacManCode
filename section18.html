<!DOCTYPE html>
<html>
  <head>
    <title>Pacman Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins|Press+Start+2P' rel='stylesheet' type='text/css'>  
  </head>

  <body>
    <div id="top"></div>
    <div class="page">
      <div class="navigation">
	<header>
	  <h1><img src="Images/pacman.png"/>... Pacman Code ...<img src="Images/pacman.png"/></h1>
	  <hr/>
	  <nav>
	    <ul>
	      <li><a href="index.html">Home</a></li>
	      <li><a href="code.html">Code</a></li>
	      <li><a href="clones.html">Clones</a></li>
	      <li><a href="about.html">About</a></li>
	      <li><a href="contact.html">Contact</a></li>
	    </ul>
	  </nav>
	</header>
      </div><!--End of navigation-->
    <hr/>

    <h2>Section 18: Tying Up Loose Ends</h2>
    <div class="container">
      <h3>Setup</h3>
      <p>We pretty much have a finished Pacman games at this point.  I know that it doesn't look sexy or anything.  There's no graphics, sound, or splash screens.  All we have are circles and lines.  That's really all you need to make this game though.  You can think of this version as the Atari version.  In the next phase we'll add the flash and pizaz.  But, we're still not quite finished with the Atari version.  There are a few loose ends that we need to tie up.  There aren't very many, and they won't change the way the game is played or anything.  But, they will help in making the game feel more like Pacman even without the graphics.</p>
      <p>Below is a list of things we need to address and solve before this section is through.
	<ol>
	  <li>We need to modify Blinky's scatter goal.  You may have noticed that ever since we forced him to move LEFT at the start of the game he just circles around the ghost home instead of the upper right corner.  I'll explain why and what we will do to fix it</li>
	<li>When the ghosts change modes, they actually need to reverse direction.  I may have mentioned before that the ghosts never backtrack when they reach a node.  This is normally true.  However, whenever they change modes they do reverse their direction as a visual cue to the player.  It's not a necessary addition, but we'll include it in our game.</li>
	<li>On that same note, the ghosts also reverse direction whenver Pacman eats a power pellet.  This is really the same thing as the previous point because when Pacman eats a power pellet, the ghost's mode changes, so they should reverse direction.</li>
	<li>I should also point out that the reversing direction rule when the mode changes isn't always true.  For example, the ghost should not reverse direction when the mode changes from FREIGHT to SPAWN.  The ghost should also not reverse direction when the mode changes from SPAWN to any other mode.  So, really what I'm saying is that the ghosts only reverse direction when their modes change from any mode to FREIGHT and when they change from SCATTER to CHASE and from CHASE to SCATTER.  </li>
	<li>When Pacman eats a ghost that is in FREIGHT mode, the game pauses for half a second.  The game does not pause when Pacman eats a fruit, however.  </li>
	<li>We need to make the collision radiuses for Pacman and the Ghosts a bit smaller.  They really shouldn't collide unless they're right on top of each other.  We should allow a bit of overlap of the objects before we register a collision.  It just looks better that way. </li>
	<li>When Pacman loses a life, we need to pause the game for one second.  This time will be used to show the death animation later on in the next phase.</li>
	<li>It would also be nice to get rid of some of the hard-coded values.  I know at the time I mentioned that I was going to eventually do that.  Well, now is the time.</li>  
      </ol></p>
    </div><!--End of Setup container-->


    <div class="container">
      <h3>Reversing Direction For the Ghosts</h3>
      <h4>Create a new method called <span class="mn">reverseGhostDirection</span></h4>
      <div class="pseudoCode">
	<p>There is already a method called <span class="mn">reverseDirection</span> that the ghosts inherited, so we don't want to overwrite that.  So that's why we call it <span class="mn">reverseGhostDirection</span> even though it is redundant.  We only want to reverse the direction of the ghosts that have left the home.  Ignore any ghosts still trapped in the ghost home.  Looking at you Inky and Clyde!</p>
      </div>
      <div class="codeText">
	<code>
	  def reverseGhostDirection(self):
	  <div class="tabLeft">
	    if self.leftHome:
	    <div class="tabLeft">
	      self.reverseDirection()
	    </div>
	  </div>
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">modeUpdate</span> method</h4>
      <div class="pseudoCode">
	<p>This method gets called when a mode timer has run out and we need to pop off the next mode.  This usually only gets called when switching between CHASE and SCATTER modes.  But it will also get called when the FREIGHT mode timer runs out.  Those are the only modes with timers, so those are the only times this will get called.  Which is perfect because we want the ghosts to reverse direction in all of those cases.</p>
      </div>
      <div class="codeText">
	<code>
	  def modeUpdate(self, dt):
	  <div class="tabLeft">
	    <p>...</p>
	    if self.modeTimer >= self.mode.time:
	    <div class="tabLeft">
	      self.reverseGhostDirection()<br>
	      <p>...</p>
	    </div>
	  </div>
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">setFreightMode</span> method</h4>
      <div class="pseudoCode">
	<p>This is called when Pacman eats a power pellet and we change the ghost's mode to FREIGHT.  We only reverse their direction if their previous mode was SCATTER or CHASE.  </p>
      </div>
      <div class="codeText">
	<code>
	  def setFreightMode(self):
	  <div class="tabLeft">
	    if self.mode.name != "FREIGHT" and self.mode.name != "SPAWN":
	    <div class="tabLeft">
	      <p>...</p>
	      self.reverseGhostDirection()<br>
	      self.mode = Mode("FREIGHT", time=7, speedMult=0.5)<br>
	      self.modeTimer = 0
	    </div>
	    <p>...</p>
	  </div>
	</code>
      </div>
      

    </div><!--End of container-->

    <div class="container">
      <h3>Pausing While Eating a Ghost</h3>
      <p>When Pacman eats a ghost that is in FREIGHT mode, the game needs to pause for half a second.  Play any Pacman game and you'll know that this is true.  We don't need to do this, but I kind of like it.  I don't know why, maybe it offers a small break in the action or something, or maybe it's just there to let the player know that they've just eaten a ghost.  Anyways, the only way the game pauses right now is if the player presses the space bar.  We now need a way for the game to pause for a specific amount of time, then unpause itself.  We also need a way to differentiate between these two types of pauses: a pause initiated by the game, and a pause initiated by the player.</p>
   
      <h4>Modify the <span class="filenames">gamecontrol.py</span> file</h4>
      <h4>Modify the <span class="mn">startGame</span> and <span class="mn">restartLevel</span> methods</h4>
      <div class="pseudoCode">
	<p>We are going to add a <span class="var">pauseTimer</span> which will keep track of how much time has passed while the game is paused.  The <span class="var">pauseTime</span> variable will hold the amount of time the game should remain paused in seconds.  The variable <span class="var">playerPaused</span> will tell the game that the player initiated the pause if it is <span class="py">True</span>.</p>
      </div>
      <div class="codeText">
	<code>
	  <p>...</p>
	  self.pauseTimer = 0<br>
	  self.pauseTime = 0<br>
	  self.playerPaused = False
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">checkEvents</span> method</h4>
      <div class="pseudoCode">
	<p>When the game starts we want to wait until the player presses the space bar.  Whenever the player presses the space bar to pause the game we set the <span class="var">paused</span> and <span class="var">playerPaused</span> variables to <span class="py">True</span> to let the game know that the player paused the game.  When the player presses the space bar to unpause the game, we set those variables to <span class="py">False</span> to let the game know that any pauses it encounters now will be caused by the game and not by the player.</p>
      </div>
      <div class="codeText">
	<code>
	  def checkEvents(self):
	  <div class="tabLeft">
	    <p>...</p>
	    if event.key == K_SPACE:
	    <div class="tabLeft">
	      if self.paused:
	      <div class="tabLeft">
		self.paused = False<br>
		self.playerPaused = False
	      </div>
	      else:
	      <div class="tabLeft">
		self.paused = True<br>
		self.playerPaused = True
	      </div>
	    </div>
	  </div>
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">checkGhostEvents</span> method</h4>
      <div class="pseudoCode">
	<p>When Pacman eats a ghost we need to pause the game and pause it for half a second.  If that is too long or too short, then we can always modify it here.  </p>
      </div>
      <div class="codeText">
	<code>
	  def checkGhostEvents(self, dt):
	  <div class="tabLeft">
	    <p>...</p>
	    if ghost.mode.name == "FREIGHT":
	    <div class="tabLeft">
	      <p>...</p>
	      self.paused = True<br>
	      self.pauseTime = 0.5<br>
	      self.pauseTimer = 0
	    </div>
	  </div>
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">update</span> method</h4>
      <div class="pseudoCode">
	<p>If the game is paused, then we first check to see if the player paused the game.  If the player did pause the game, then we ignore the rest because we want to keep the game paused until the player unpauses the game.  If the player didn't pause the game, then the game paused itself.  In that case we keep the game paused for the specified amount of time, after which we unpause the game.</p>
      </div>
      <div class="codeText">
	<code>
	  def update(self):
	  <div class="tabLeft">
	    dt = self.clock.tick(30) / 1000.0<br>
	    if not self.paused:
	    <div class="tabLeft">
	      <p>...</p>
	    </div>
	    else:
	    <div class="tabLeft">
	      if not self.playerPaused:
	      <div class="tabLeft">
		self.pauseTimer += dt<br>
		if self.pauseTimer >= self.pauseTime:
		<div class="tabLeft">
		  self.paused = False
		</div>
	      </div>
	    </div>
	  </div>
	</code>
      </div>
      <hr/>

    </div><!--End of container-->

    <div class="container">
      <h3>Pausing When Pacman Dies</h3>
      <p>This will be easy because we already took care of setting up the neccessary variables above.  </p>
      <h4>Modify the <span class="filenames">gamecontrol.py</span> file</h4>
      <h4>Modify the <span class="mn">__init__</span> method</h4>
      <div class="pseudoCode">
	<p>If we want to delay the start and restart of the game, then these variables will be set to <span class="py">True</span> instead of calling the required methods first.  </p>
      </div>
      <div class="codeText">
	<code>
	  <p>...</p>
	  self.startDelay = False<br>
	  self.restartDelay = False
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">startGame</span> method</h4>
      <div class="pseudoCode">
	<p>If we want to delay the start and restart of the game, then these variables will be set to <span class="py">True</span>.  </p>
      </div>
      <div class="codeText">
	<code>
	  <p>...</p>
	  self.startDelay = False
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">restartLevel</span> method</h4>
      <div class="pseudoCode">
	<p>If we want to delay the start and restart of the game, then these variables will be set to <span class="py">True</span>.  </p>
      </div>
      <div class="codeText">
	<code>
	  <p>...</p>
	  self.restartDelay = False
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="filenames">gamecontrol.py</span> file</h4>
      <h4>Modify the <span class="mn">checkGhostEvents</span> method</h4>
      <div class="pseudoCode">
	<p>So instead of calling <span class="mn">restartLevel</span> method directly as we've been doing we just set the <span class="var">restartDelay</span> variable to <span class="py">True</span>.  If we called the <span class="mn">restartLevel</span> method here, then the game wouldn't pause like we want it to.  We'll need to call that method after the pause period has finished.</p>
      </div>
      <div class="codeText">
	<code>
	  def checkGhostEvents(self, dt):
	  <div class="tabLeft">
	    <p>...</p>
	    if ghost.mode.name == "FREIGHT":
	    <div class="tabLeft">
	      <p>...</p>
	    </div>
	    elif ghost.mode.name != "SPAWN":
	    <div class="tabLeft">
	      self.paused = True<br>
	      self.pauseTime = 1<br>
	      self.pauseTimer = 0<br>
	      self.restartDelay = True
	      <p>...</p>
	      
	    </div>
	  </div>
	</code>
      </div>
      <hr/>
      
      <h4>Modify the <span class="mn">update</span> method</h4>
      <div class="pseudoCode">
	<p>This is where we want to call the <span class="mn">startGame</span> and <span class="mn">restartLevel</span> classes.  That way we wait for the pause to finish before the game restarts or the level restarts.  There's always going to be a pause before we want to call these methods anyways, so this is a good place to put them.</p>
      </div>
      <div class="codeText">
	<code>
	  def update(self):
	  <div class="tabLeft">
	    <p>...</p>
	    if not self.paused:
	    <div class="tabLeft">
	      <p>...</p>
	    </div>
	    else:
	    <div class="tabLeft">
	      if not self.playerPaused:
	      <div class="tabLeft">
		self.pauseTimer += dt<br>
		if self.pauseTimer >= self.pauseTime:
		<div class="tabLeft">
		  self.paused = False<br>
		  if self.startDelay == True:
		  <div class="tabLeft">
		    self.startGame()
		  </div>
		  if self.restartDelay == True:
		  <div class="tabLeft">
		    self.restartLevel()
		  </div>
		  
		</div>
	      </div>
	    </div>
	  </div>
	</code>
      </div>
      
    </div><!--End of container-->

    <div class="container">
      <h3>Pausing When the Player Passes a Level</h3>
      <p>All of this pausing and unpausing should be trivial now.  When the player passes a level we want to pause the game because we're going to add something later in the next phase.  Right now we'll pause the game for 3 seconds, but that can change.</p>
      <h4>Modify the <span class="filenames">gamecontrol.py</span> file</h4>
      <h4>Modify the <span class="mn">checkPelletEvents</span> method</h4>
      <div class="pseudoCode">
	<p>We set the <span class="var">startDelay</span> to <span class="py">True</span> so the game will pause for the specified time before restarting the game.</p>
      </div>
      <div class="codeText">
	<code>
	  def checkPelletEvents(self, dt):
	  <div class="tabLeft">
	    <p>...</p>
	    if self.pellets.isEmpty():
	    <div class="tabLeft">
	      self.paused = True<br>
	      self.pauseTime = 3<br>
	      self.pauseTimer = 0<br>
	      self.startDelay = True
	      <p>...</p>
	    </div>
	  </div>
	</code>
      </div>
      <hr/>
    </div><!--End of container-->

    <div class="container">
      <h3>Fiddle Around with Collision Radiuses</h3>
      <h4>Modify the <span class="filenames">pacman.py</span> file</h4>
      <h4>Modify the <span class="mn">__init__</span> method</h4>
	<p>We don't want the objects to collide on their edges, we want to make it look like that Pacman is actually eating the pellets, ghosts, and fruit.  So we need to reduce the collision radius so that it's inside the bounds of the objects.  I like using a radius of 4 works really well.</p>
      <div class="pseudoCode">
	<p>This will be the collision radius.  Different from the actual radius of the object.  </p>
      </div>
      <div class="codeText">
	<code>
	  <p>...</p>
	  self.r = 4
	</code>
      </div>
      <hr/>

      <h4>Modify the <span class="mn">eatObject</span> method</h4>
      <div class="pseudoCode">
	<p>We write it like this because (r + r)<sup>2</sup> = 4 * r<sup>2</sup></p>
      </div>
      <div class="codeText">
	<code>
	  def eatObject(self, obj):
	  <div class="tabLeft">
	    <p>...</p>
	    rSquared = 4 * self.r**2<br>
	    <p>...</p>
	  </div>
	</code>
      </div>
      

    </div><!--End of container-->

    <div class="container">
      <h3>Getting Rid of Hard-Coded Values</h3>
      <div class="pseudoCode">
	
      </div>
      <div class="codeText">
	<code>

	</code>
      </div>
      <hr/>

    </div><!--End of container-->



    
    
    <div class="container">  
      <h3>Conclusion</h3>
      <p>Well, there you have it.  I think we can actually call this a game.  It has a start and an ending.  There are goals to achieve, and it's something you can get better at with repeated play.  Even so, nobody would bat an eyelash at this as it stands.  People have come to expect some form of graphics in their games.  Animation, sound, and music is also a given.  None of that really affects the way the game is played, so that's why I didn't cover any of that in this phase.  This phase was all about getting the gameplay down.  Now that we have that we can focus on adding the visual aspects of the game.  It's important to note that anything we add from here on out should not change the way the game is played or break the game.  Anything we add should only change the way the game looks.  </p>

    </div> <!--End of the conclusion container-->
    <hr />

    <div class="container">
      <h2>File Structure</h2>
      <ul>
	<li>Pacman</li>
	<ul>
	  <li>constants.py</li>
	  <li>entities.py</li>
	  <li>fruit.py</li>
	  <li>gamecontrol.py</li>
	  <li>ghosts.py</li>
	  <li>home.txt</li>
	  <li>maze1.txt</li>
	  <li>nodes.py</li>
	  <li>pacman.py</li>
	  <li>pellets.py</li>
	  <li>stacks.py</li>
	  <li>vectors.py</li>
	</ul>
      </ul>
    </div><!--End of File Structure container-->
    </div><!--End of Page container-->


    <div class="buffer"></div>
    <footer>
      <div class="bottomNav">
	<ul>
	  <li><a href="section17.html">Previous</a></li>
	  <li><a href="#top">Top</a></li>
	  <li><a href="section19.html">Next</a></li>
	</ul>
      </div>
    </footer>
  </body>
</html>
